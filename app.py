# -*- coding: utf-8 -*-
# ===========================================================
# AI-Deal-Checker â€“ ×’×¨×¡×” 2.5 Flash ×××•×–× ×ª ×¢× ×”×¦×œ×‘×” ×—×›××”
# ===========================================================

import streamlit as st
import google.generativeai as genai
import json
from json_repair import repair_json
from PIL import Image
import traceback

# ---------- ×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª ----------
st.set_page_config(page_title="AI Deal Checker ğŸš—", page_icon="ğŸš—", layout="centered")

# ×§×¨×™××ª ××¤×ª×— API
api_key = st.secrets["GEMINI_API_KEY"]
genai.configure(api_key=api_key)

# ×©×™××•×© ×‘××•×“×œ Gemini 2.5 Flash
model = genai.GenerativeModel("gemini-2.5-flash")

# ---------- ×××©×§ ----------
st.title("ğŸš— AI Deal Checker â€“ ×‘×“×™×§×ª ×›×“××™×•×ª ×—×›××” ×•×××•×–× ×ª")
st.write("×”×¢×ª×§ ××ª ×˜×§×¡×˜ ×”××•×“×¢×” (×›×•×œ×œ ××—×™×¨, ×©× ×”, ×§×´× ×•×›×•×³) ×•×”×¢×œ×” ×ª××•× ×•×ª ×©×œ ×”×¨×›×‘ ×œ×‘×™×¦×•×¢ ×”×¦×œ×‘×” ×‘×™×Ÿ × ×ª×•× ×™ ×”××•×“×¢×” ×œ× ×ª×•× ×™ ×”×©×•×§ ×‘×¤×•×¢×œ:")

ad_text = st.text_area("ğŸ“‹ ×”×“×‘×§ ×›××Ÿ ××ª ×˜×§×¡×˜ ×”××•×“×¢×”:", height=250)
uploaded_images = st.file_uploader(
    "ğŸ“¸ ×”×¢×œ×” ×ª××•× ×•×ª ×©×œ ×”×¨×›×‘ (× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×›××”):",
    type=["jpg", "jpeg", "png"],
    accept_multiple_files=True
)

st.markdown(
    """
    <div style='background-color:#fff3cd; border-radius:10px; padding:10px; border:1px solid #ffeeba;'>
    âš ï¸ <b>×”×‘×”×¨×”:</b> × ×™×ª×•×— ×–×” ××‘×•×¡×¡ ×‘×™× ×” ××œ××›×•×ª×™×ª ×•××™× ×• ×ª×—×œ×™×£ ×œ×‘×“×™×§×” ××§×¦×•×¢×™×ª.
    <br>×™×© ×œ×‘×§×© ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™× ××œ××” ×•×œ×”×•×¦×™× ×“×•×´×— ×¢×‘×¨ ×‘×™×˜×•×—×™ ×œ×¤× ×™ ×¨×›×™×©×”.
    </div>
    """,
    unsafe_allow_html=True
)

# ---------- ×¤×¢×•×œ×” ----------
if st.button("×—×©×‘ ×¦×™×•×Ÿ ×›×“××™×•×ª"):
    if not ad_text.strip() and not uploaded_images:
        st.error("×× × ×”×“×‘×§ ×˜×§×¡×˜ ××• ×”×¢×œ×” ×œ×¤×—×•×ª ×ª××•× ×” ××—×ª.")
    else:
        with st.spinner("ğŸ” ××‘×¦×¢ ×”×¦×œ×‘×” ×—×›××” ×‘×™×Ÿ × ×ª×•× ×™ ×”××•×“×¢×” ×œ× ×ª×•× ×™ ×”×©×•×§..."):
            try:
                # ----- ×¤×¨×•××¤×˜ -----
                prompt = f"""
××ª×” ×× ×œ×™×¡×˜ ××•××—×” ×œ×©×•×§ ×”×¨×›×‘ ×”×™×©×¨××œ×™. ××˜×¨×ª×š ×”×™× ×œ×‘×¦×¢ ×”×¢×¨×›×ª ×›×“××™×•×ª ×›×•×œ×œ×ª ×œ×¨×›×‘ ××©×•××©
×¢×œ ×‘×¡×™×¡ ×˜×§×¡×˜ ×”××•×“×¢×” (×©×¦×•×¨×£ ×œ××˜×”) ×•×”×ª××•× ×•×ª, ×ª×•×š ×”×¦×œ×‘×” ×¢× × ×ª×•× ×™ ×©×•×§ ×¢×“×›× ×™×™× ×•××™×“×¢ ×××™× ×•×ª.

×”×”×¢×¨×›×” ×©×œ×š ×—×™×™×‘×ª ×œ×”×™×•×ª ××“×•×™×§×ª, ×©×§×•×œ×” ×•××‘×•×¡×¡×ª ×¢×œ ×¢×•×‘×“×•×ª â€“ ×œ× ×¢×œ ×–×”×™×¨×•×ª ×™×ª×¨.

---

ğŸ”¹ **×©×œ×‘ 1 â€“ × ×™×ª×•×— ×ª×•×›×Ÿ ×”××•×“×¢×”**
×§×¨× ×‘×¢×™×•×Ÿ ××ª ×”×˜×§×¡×˜ ×”×‘× ×©×œ ×”××•×“×¢×”:
\"\"\"{ad_text}\"\"\"
×”×¤×§ ××× ×• ××ª ×”× ×ª×•× ×™× ×”××¤×©×¨×™×™×:
×™×¦×¨×Ÿ, ×“×’×, ×’×¨×¡×”, ××—×™×¨, ×§×™×œ×•××˜×¨××–×³, ×©× ×”, ×ª×™×‘×ª ×”×™×œ×•×›×™×, ×¡×•×’ ×× ×•×¢, ×¨××ª ×’×™××•×¨, ×™×“, ×¦×‘×¢, ××–×•×¨, ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×, ×˜×¡×˜, ×‘×¢×œ×•×ª × ×•×›×—×™×ª ×•×§×•×“××ª, ××¦×‘ ×›×œ×œ×™, ×•×¢×•×“.
×¦×™×™×Ÿ ×‘××¤×•×¨×© ××™×œ×• × ×ª×•× ×™× ×”×•×¤×§×• ×™×©×™×¨×•×ª ××”××•×“×¢×”.

---

ğŸ”¹ **×©×œ×‘ 2 â€“ × ×ª×•× ×™ ×©×•×§ ×—×™×¦×•× ×™×™×**
×—×¤×© ×‘××™× ×˜×¨× ×˜ ××™×“×¢ ×¢×œ ×”×“×’× ×•×”×©× ×”:
- ××—×™×¨ ×©×•×§ ×××•×¦×¢ (×™×“ 2 / ×œ×•×™ ×™×¦×—×§)
- ×“×™×¨×•×’ ×××™× ×•×ª ×•×ª×—×–×•×§×”
- ×¢×œ×•×™×•×ª ×˜×™×¤×•×œ×™× ×©× ×ª×™×•×ª
- ×ª×§×œ×•×ª ×™×“×•×¢×•×ª ××• × ×§×•×“×•×ª ×—×•×œ×©×”
- ×‘×™×§×•×© ×‘×©×•×§, ×©××™×¨×ª ×¢×¨×š ×•×–××™× ×•×ª ×—×œ×§×™×
- ×“×™×¨×•×’ ×‘×˜×™×—×•×ª

---

ğŸ”¹ **×©×œ×‘ 3 â€“ ×”×©×•×•××” ×•×”×¦×œ×‘×”**
×”×©×•×•×” ×‘×™×Ÿ ×”× ×ª×•× ×™× ××”××•×“×¢×” ×œ×‘×™×Ÿ ×”××™×“×¢ ××”×©×•×§:
- ×”×× ×”××—×™×¨ ×”××‘×•×§×© ×’×‘×•×”, × ××•×š ××• ×ª×•××?
- ×”×× ××¦×‘ ×”×¨×›×‘ ×‘××•×“×¢×” ×ª×•×× ×œ××” ×©×¦×¤×•×™ ×œ×¤×™ ×’×™×œ ×•×§×´×?
- ×”×× ×™×© × ×™×¡×•×—×™× ×‘×¢×™×™×ª×™×™× ××• ×”×¡×ª×¨×ª ××™×“×¢?

---

ğŸ”¹ **×©×œ×‘ 4 â€“ ×©×™×§×•×œ×™ ×–×”×™×¨×•×ª ×¦×¨×›× ×™×ª**
×¢×œ×™×š ×œ×”×•×¨×™×“ ×¦×™×•×Ÿ ×¨×§ ×× ××ª×§×™×™××™× ×ª× ××™× ×‘×¨×•×¨×™× ×©×œ ×¡×™×›×•×Ÿ, ×œ×¤×™ ×”×›×œ×œ×™× ×”×‘××™×:

âœ… **××™×–×•×Ÿ ××—×™×¨:**
- ×× ×”××—×™×¨ × ××•×š ×¢×“ 10% ×××—×™×¨ ×”×©×•×§ ×•××™×Ÿ ×¡×™×× ×™ ×‘×¢×™×” (×ª××•× ×•×ª, × ×™×¡×•×—×™× ××¢×•×¨×¤×œ×™×, ×¨×›×‘ ××•×–× ×—) â€” ×–×” × ×—×©×‘ ×“×™×œ ×˜×•×‘, ××œ ×ª×•×¨×™×“ ×¦×™×•×Ÿ.
- ×× ×”××—×™×¨ × ××•×š ×‘×™×•×ª×¨ ×Ö¾15% ×œ×œ× ×”×¡×‘×¨ ×”×’×™×•× ×™ â€” ×–×” ×—×¨×™×’ ×•×“×•×¨×© ×”×•×¨×“×ª ×¦×™×•×Ÿ.
- ×× ×”××—×™×¨ ×’×‘×•×” ××”×©×•×§ ×‘×™×•×ª×¨ ×Ö¾10% ×œ×œ× ×”×¦×“×§×” (×’×™××•×¨, ××‘×–×•×¨) â€” ×”×•×¨×“ ××¢×˜ ×¦×™×•×Ÿ.

âœ… **××™×–×•×Ÿ ×™×“×™×™×:**
- ×¨×›×‘ ×‘×Ÿ 5â€“7 ×©× ×™× ×¢× ×™×“ 3â€“4 = ××¦×‘ ×¡×‘×™×¨, ×œ× ×¡×™×›×•×Ÿ.
- ×¨×§ ××¢×œ ×™×“ 4, ××• ×ª×“×™×¨×•×ª ××›×™×¨×” ×’×‘×•×”×” (3 ×™×“×™×™× ×‘Ö¾4 ×©× ×™×), × ×—×©×‘ ×—×¨×™×’.

âœ… **×”×ª×¨×—×™×©×™× ×©×‘×”× ×—×•×‘×” ×œ×”×–×”×™×¨ ××• ×œ×”×•×¨×™×“ ×¦×™×•×Ÿ:**
1. ××—×™×¨ × ××•×š ××“×™ ×‘×™×—×¡ ×œ×©×•×§ (15%+).
2. ×¨×›×‘ ×™×©×Ÿ ×¢× ××—×–×§×” ×™×§×¨×”.
3. ×§×™×œ×•××˜×¨××–×³ ×’×‘×•×” (180,000+ ×§"×).
4. ××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×.
5. ×¨×›×‘ ×œ×™×¡×™× ×’/×—×‘×¨×” ××• ×”×©×›×¨×”.
6. × ×™×¡×•×— ×¢××•× ("××¦×‘ ×˜×•×‘ ×××•×“") ×œ×œ× ×”×•×›×—×•×ª.
7. ×¦×‘×¢ ××•×—×œ×£ ××• ×¦×™×•×Ÿ ×©×œ ×¤×—×—×•×ª.
8. ×× ×•×¢ ×˜×•×¨×‘×• ××• ×“×™×–×œ ×™×©×Ÿ.
9. ×¨×›×‘ ××©×•×¤×¨ (×¦×³×™×¤, ××’×–×•×– ×•×›×•×³).
10. ×‘×™×§×•×© × ××•×š ×‘×©×•×§.
11. ××™×Ÿ ×˜×¡×˜ ×‘×ª×•×§×£.
12. ××—×™×¨ ×’×‘×•×” ×œ×’×¨×¡×” ×‘×¡×™×¡×™×ª.
13. ×¨×›×‘ ×—×©××œ×™ ×™×©×Ÿ ×¢× ×¡×•×œ×œ×” ×œ× × ×‘×“×§×”.
14. ×‘×¢×œ×•×ª ×œ× ×‘×¨×•×¨×” ××• ×™×“ ××¨×•×‘×” ×™×—×¡×™×ª ×œ×’×™×œ.
15. ×ª××•× ×”/×¤×’×™×¢×” ×‘×©×œ×“×” â€” ×¦×™×•×Ÿ ×œ× ×™×¢×‘×•×¨ 50.

---

ğŸ”¹ **×©×œ×‘ 5 â€“ ×—×™×©×•×‘ ×¦×™×•×Ÿ ×¡×•×¤×™**
×—×©×‘ ××ª ×”×¦×™×•×Ÿ (0â€“100) ×œ×¤×™ ×”××©×§×œ×•×ª:
- ××—×™×¨ ××•×œ ×©×•×§ â€“ 25%
- ××¦×‘ ×ª×—×–×•×§×ª×™ ×•××›×× ×™ â€“ 25%
- ×××™× ×•×ª ×“×’× â€“ 20%
- ×’×™×œ ×•×§×™×œ×•××˜×¨××–×³ â€“ 15%
- ×××™× ×•×ª ××•×›×¨ â€“ 10%
- ×‘×™×§×•×© ×œ×“×’× â€“ 5%

---

ğŸ”¹ **×©×œ×‘ 6 â€“ ×”×¤×œ×˜**
×”×—×–×¨ ××š ×•×¨×§ JSON ×ª×§× ×™ ×‘×¤×•×¨××˜ ×”×‘×:
{{
  "from_ad": {{
    "brand": "",
    "model": "",
    "year": 0,
    "mileage_km": 0,
    "price_nis": 0,
    "ad_claims": ["×¤×¨×˜ 1", "×¤×¨×˜ 2"]
  }},
  "from_internet": {{
    "market_estimate_nis": 0,
    "reliability_score": 0,
    "avg_maintenance_cost": 0,
    "demand_level": "× ××•×š" | "×‘×™× ×•× ×™" | "×’×‘×•×”",
    "known_issues": ["×‘×¢×™×” 1", "×‘×¢×™×” 2"]
  }},
  "cross_analysis": {{
    "price_alignment": "×’×‘×•×”" | "× ××•×š" | "×¡×‘×™×¨",
    "condition_alignment": "×ª×•××" | "×œ× ×ª×•××",
    "key_differences": ["×¤×¢×¨ 1", "×¤×¢×¨ 2"]
  }},
  "deal_score": 0,
  "classification": "×¢×¡×§×” ××¢×•×œ×”" | "×¢×¡×§×” ×˜×•×‘×”" | "×¢×¡×§×” ×¡×‘×™×¨×”" | "×™×§×¨×” ××“×™" | "××¡×•×›× ×ª",
  "short_verdict": "×¡×™×›×•× ×× ×œ×™×˜×™ ×§×¦×¨ ×‘×¢×‘×¨×™×ª",
  "key_reasons": ["×¡×™×‘×” 1", "×¡×™×‘×” 2", "×¡×™×‘×” 3"],
  "user_info": {{
    "reliability_summary": "×ª×™××•×¨ ×§×¦×¨ ×¢×œ ×××™× ×•×ª ×”×“×’× ×œ×¤×™ ××§×•×¨×•×ª ×¦×™×‘×•×¨×™×™×",
    "maintenance_tips": ["×˜×™×¤ 1", "×˜×™×¤ 2"],
    "common_faults": ["×ª×§×œ×ª ××œ×§×˜×¨×•× ×™×§×”", "×ª×™×‘×ª ×”×™×œ×•×›×™× ×¨×•×‘×•×˜×™×ª ×¨×’×™×©×”"],
    "market_context": "××™×“×¢ ×›×œ×œ×™ ×¢×œ ×”×“×’× â€“ ×‘×™×§×•×©, ×—×œ×§×™×, ×—×•×•×™×™×ª × ×”×™×’×”"
  }}
}}
××œ ×ª×›×ª×•×‘ ×©×•× ×˜×§×¡×˜ ×œ×¤× ×™ ××• ××—×¨×™ ×”Ö¾JSON.
"""

                # ----- ×§×¨×™××” ×œ××•×“×œ -----
                inputs = [prompt]
                for img in uploaded_images:
                    inputs.append(Image.open(img))

                response = model.generate_content(inputs, request_options={"timeout": 120})

                # ×ª×™×§×•×Ÿ JSON ××•×˜×•××˜×™
                fixed_json = repair_json(response.text)
                data = json.loads(fixed_json)

                # ----- ×”×¦×’×ª ×ª×•×¦××•×ª -----
                score = data["deal_score"]
                if score >= 80:
                    color = "#28a745"
                elif score >= 60:
                    color = "#ffc107"
                else:
                    color = "#dc3545"

                st.markdown(
                    f"<h3 style='color:{color}'>ğŸš¦ ×¦×™×•×Ÿ ×›×“××™×•×ª ×›×•×œ×œ: {score}/100 â€” {data['classification']}</h3>",
                    unsafe_allow_html=True
                )
                st.write("ğŸ§¾ **×¡×™×›×•×:**", data["short_verdict"])
                st.divider()

                st.subheader("ğŸ“‹ × ×ª×•× ×™× ××ª×•×š ×”××•×“×¢×”:")
                st.json(data["from_ad"])

                st.subheader("ğŸŒ × ×ª×•× ×™ ×©×•×§ ×©× ××¦××• ×‘××™× ×˜×¨× ×˜:")
                st.json(data["from_internet"])

                st.subheader("ğŸ” ×”×¦×œ×‘×” ×•× ×™×ª×•×— ×¤×¢×¨×™×:")
                st.json(data["cross_analysis"])

                st.subheader("ğŸ§  ×¡×™×‘×•×ª ×¢×™×§×¨×™×•×ª ×œ×¦×™×•×Ÿ:")
                for r in data["key_reasons"]:
                    st.write(f"â€¢ {r}")

                # ××™×“×¢ × ×•×¡×£ ×œ××©×ª××©
                st.divider()
                st.subheader("ğŸ“š ××™×“×¢ × ×•×¡×£ ×œ××©×ª××©")
                info = data.get("user_info", {})
                if info:
                    st.write(f"**×××™× ×•×ª ×”×“×’×:** {info.get('reliability_summary', '×œ× ×¦×•×™×Ÿ')}")
                    if info.get("common_faults"):
                        st.write("**×ª×§×œ×•×ª × ×¤×•×¦×•×ª:**")
                        for f in info["common_faults"]:
                            st.write(f"â€¢ {f}")
                    if info.get("maintenance_tips"):
                        st.write("**×˜×™×¤×™× ×œ×ª×—×–×•×§×”:**")
                        for tip in info["maintenance_tips"]:
                            st.write(f"â€¢ {tip}")
                    if info.get("market_context"):
                        st.write("**×”×§×©×¨ ×©×•×§ ×›×œ×œ×™:**", info["market_context"])
                else:
                    st.info("×œ× ×¡×•×¤×§ ××™×“×¢ × ×•×¡×£ ×¢×œ ×”×“×’×.")

                st.caption("Â© 2025 Car Advisor AI â€“ AI-Deal-Checker | ×’×¨×¡×ª Gemini 2.5 Flash ×××•×–× ×ª")

            except Exception as e:
                st.error("âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ×”×¤×œ×˜ ××• ×‘×§×¨×™××ª ×”××™×“×¢ ××”××•×“×œ.")
                st.code(traceback.format_exc())
